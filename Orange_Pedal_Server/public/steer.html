<!doctype html>

<html>
  <head>
    <title>Project Joystick</title>
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1" />
    
    <script src="/socket.io/socket.io.js"></script>

    <script>

      var socket = io({role:"steer"});
      var SteerPos = new Array();
      var steerDisplay = null;

      var stableVal={
          rotate : null,
      }

      //-----------JoySticks UI------------//
        
          
      function sendSteerPos(){

          SteerPos[0] = stableVal.rotate;
          SteerPos[1] = CurrentGearPos;
          SteerPos[2] = trueTorque;

          if(stableVal.rotate){
            socket.emit('steer',SteerPos);
          }
          setTimeout(function(){sendSteerPos();},50);

      }

      window.addEventListener("load",function(){

          steerDisplay = document.getElementById("steerDisplay");
          var dashDisplay = document.getElementById("dashDisplay");
          var gear = document.getElementById("gear");
          var gearStick = document.getElementById("gearStick");          

          steerDisplay.style.height = steerDisplay.offsetWidth + "px";
          steerDisplay.style.lineHeight = steerDisplay.offsetWidth * 0.9 + "px";
          dashDisplay.style.height = dashDisplay.offsetWidth + "px";

          gear.style.height = gear.offsetWidth * 3.8 + "px";
          gearStick.style.height = gearStick.offsetWidth + "px";
          gearStick.style.lineHeight = gearStick.offsetWidth * 0.9 + "px";

          window.addEventListener('devicemotion',function(event){
            var acceleration = event.accelerationIncludingGravity;
            tilt = acceleration.y/9.8;
            stableVal.rotate += ( tilt - stableVal.rotate) * 0.2;
            steerDisplay.style.webkitTransform = "rotateZ("+ 90 * stableVal.rotate + "deg)";
          });

          document.getElementById("shiftUp").addEventListener( "click" , function(){
            if(CurrentGearPos > 0 ){
            CurrentGearPos--;
            checkGearPos();
            }
          });

          document.getElementById("shiftDown").addEventListener( "click" , function(){
            if(CurrentGearPos <  GearName.length-1){
            CurrentGearPos++;
            checkGearPos();
            }
          });

          sendSteerPos();

      });  

      socket.on('tachBack', function(msg){
         tachDisVal = Math.floor((msg/210)*(450));
         mphVal = msg;
         tachHide.style.backgroundPosition = 'center ' + -1 * Math.abs(tachDisVal) + "px";
         steerDisplay.innerHTML = Math.abs(mphVal);

         if(CurrentGearPos == 0){
          trueTorque = 260 - mphVal;
         }
         else if(CurrentGearPos == 1){
          trueTorque = 585 - 8*mphVal;
         }
         else if(CurrentGearPos == 3){
          trueTorque = 1;
         }
         else if(CurrentGearPos == 4){
          trueTorque = 1;
         }
         else if(CurrentGearPos == 5){
          trueTorque = -65;
         }
      });

      //Gear Stuff//

      var PGearPush = 0; 
      var GearPush = 0;
      var firstTouch = true;
      var CurrentGearPos = 3;
      var trueTorque = 0;
      var GearName = ['D','S','N','P','R'];

      document.addEventListener('touchmove', function (e) { 
        e.preventDefault();

        if(firstTouch == true){
          firstTouch = false;
          GearPush = e.targetTouches[0].clientY;
          PGearPush = GearPush;
        }
        else{
          PGearPush = GearPush;
          GearPush = e.targetTouches[0].clientY;
        }
      });

      function checkGearPos(){
        gearStick.innerHTML = '-'+GearName[CurrentGearPos]+'-';
        gearStick.style.top = 17.5 * CurrentGearPos + "%";
      }

      document.addEventListener('touchend', function () { 
        if(firstTouch == false){
          if(  GearPush - PGearPush > 10 ){
            document.getElementById("shiftDown").click();
          }else if(  GearPush - PGearPush < -10 ){
            document.getElementById("shiftUp").click();
          }
          firstTouch = true;
        }
      });

    </script>

    <style>

    html{
      position: fixed;
      height: 100%;
      width: 100%;
      margin: 0px;
      padding: 0px;
    }

    body{
        height:100%;
        width:100%;
        margin:0px;
        padding:0px;
        background-color:#222;
        background-size: 100%;
        background-position: top;
        background-repeat: no-repeat;
        background-image: url('img/shadow.svg');
        font-family: "Helvetica Neue" ,Helvetica, Arial, Verdana, sans-serif;
        font-weight:lighter;
      }

    #dashWrapper{
      position: relative;
      height: 100%;
      width: 100%;
      overflow:hidden;
    }

    #steerDisplay{
        position:absolute;
        text-align:center;
        border-radius:50%;
        background-color:#444;
        font-family:"Helvetica Neue", Helvetica, Arial, sans-serif;
        color:#00d4b9;
        width: 36%;
        background-size: 98%;
        background-position: center;
        background-repeat: no-repeat;
        background-image: url("img/engine_power.png");
        margin:auto;
        left:0px;
        right:0px;
        top:0px;
        bottom: 0px;
        font-size: 2.4em;
      }
      
      #dashDisplay{
        border-radius:50%;
        background-color:#111;
        z-index:-99;
        position: absolute;
        width: 52%;
        top:0px;
        bottom: 0px;
        right: 0px;
        left: 0px;
        margin: auto;
        border-top:solid 2px rgba(255,255,255,0.05);
        border-right:solid 2px rgba(255,255,255,0.12);
        border-left:solid 2px rgba(255,255,255,0.08);
        border-bottom:solid 2px rgba(255,255,255,0.14);
        background-size: 97%;
        background-position: center;
        background-repeat: no-repeat;
        background-image: url("img/engine_power_level.jpg");
        overflow: hidden;
      }

      #gear{
        width: 6%;
        background-color: #444;
        position: absolute;
        top: 18%;
        left:auto;
        right: 5%;
        border-radius: 40px;
        background-size: 100%;
        background-position: center;
        background-repeat: no-repeat;
        background-image: url('img/gear_box.png');
        box-shadow: 0px 2px 7px rgba(0,0,0,0.7) inset;
      }

      #gearStick{
        width: 80%;
        border-radius: 40px;
        margin: auto;
        position: relative;
        top: 52.5%;
        background-color: #666;
        cursor: pointer;
        box-shadow: 0px 4px 5px rgba(0,0,0,0.5);
        text-align: center;
        color: #FFF;
        transition : top 0.4s ease-in-out;
        transform: translateY(20%);
      }

      .shiftChange{
        height: 24%;
        width: 12%;
        position: absolute;
        background-color: #444;
        box-shadow: 0px 1px 4px rgba(0,0,0,0.4);
        top:auto;
        bottom: 4%;
        border-radius: 10px;
        color:rgba(255,255,255,0.6);
        text-align: center;
        cursor: pointer;
      }

      .shiftChangeInner{
        width: 100%;
        position: absolute;
        top: 0px;
        bottom: 0px;
        margin:auto;
        height: 32px;
        line-height: 32px;
      }

      #shiftDown{
        left: 2%;
        right: auto;
        border-top-left-radius: 65%;
      }

      #shiftUp{
        left: auto;
        right: 2%;
        border-top-right-radius: 65%;

      }

      #tachHide{
        height: 100%;
        width: 100%;
        background-size: 100% 100%;
        background-position: center 0px;
        background-repeat: no-repeat;
        background-image: url('img/tachHide.png');
      }

    </style>

  </head>

  <body>

      <div id = "dashWrapper">

        <div id="steerDisplay">
          Ready
        </div>

        <div id="dashDisplay">
          <div id = "tachHide" ></div>
        </div>

        <div id="gear">
          <div id = "gearStick">
            -P-
          </div>
        </div>

        <div class = "shiftChange" id="shiftUp">
          <div class = "shiftChangeInner">
            SHIFT+
          </div>
        </div>

        <div class = "shiftChange" id="shiftDown">
          <div class = "shiftChangeInner">
            SHIFT-
          </div>
        </div>
      </div>
  </body>
</html>